<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.7.0/css/all.css" />
        <link rel="stylesheet" href="//stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />

        <style>
            pre {
                white-space: pre-wrap;       /* css-3 */
                word-wrap: break-word;       /* Internet Explorer 5.5+ */
            }
            .initiallyHidden {
                display: none;
            }

            /* Prevent spin buttons on Firefox. */
            input[type='number'] {
                -moz-appearance:textfield;
            }

            body, .tab-content {
                height: 100%;
            }

            .nav i, .dropdown i {
                margin-right: 5px;
                margin-left: 5px;
                font-size: 1.2em;
            }

            .info-title-1 {
                margin-top: 3%;
                font-size: 1.8em;
            }

            .info-title-2 {
                margin-top: 1%;
                font-weight: bold;
            }

            .page-spacer {
                margin-top: 1%;
            }

            .section-spacer {
                margin-top: 10%;
            }

            .subsection-spacer {
                margin-top: 5%;
            }

            .button-spacer {
                margin-top: 5%;
            }
        </style>

        <title>PayTec AEM</title>
    </head>
    <body>
        <div class="container-fluid page-spacer">
            <div class="row">
                <div class="col-6">
                    <img src="https://www.paytec.ch/fileadmin/bilder/website/logo-paytec.png"></img>
                </div>
                <div class="col-6 text-right">
                    <i id="onlineProcessing" class="fas fa-phone status initiallyHidden i18n" title="Terminal is online"></i>
                    <i id="cardDataAvailable" class="fa fa-credit-card status initiallyHidden i18n" title="Card has been read"></i>
                    <i id="busy" class="fa fa-hourglass status initiallyHidden i18n" title="Terminal is busy"></i>
                    <i id="shiftOpen" class="fa fa-lock-open status activated initiallyHidden i18n" title="Shift is open"></i>
                    <i id="shiftClosed" class="fa fa-lock status deactivated i18n" title="Shift is closed"></i>
                    <i id="connected" class="fa fa-link connected initiallyHidden i18n" title="Connected to terminal"></i>
                    <i id="disconnected" class="fa fa-unlink disconnected i18n" title="No terminal connected"></i>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="navbar">
                <ul class="nav nav-tabs mr-auto">
                    <li class="nav-item">
                        <a class="nav-link active" id="paymentTab" data-toggle="tab" href="#paymentPane" role="tab" aria-controls="paymentPane" aria-selected="true">
                            <i class="fa fa-credit-card"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="receiptTab" data-toggle="tab" href="#receiptPane" role="tab" aria-controls="receiptPane" aria-selected="false">
                            <i class="fas fa-receipt"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="infoTab" data-toggle="tab" href="#infoPane" role="tab" aria-controls="infoPane" aria-selected="false">
                            <i class="fas fa-info"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="settingsTab" data-toggle="tab" href="#settingsPane" role="tab" aria-controls="settingsPane" aria-selected="false">
                            <i class="fas fa-sliders-h"></i>
                        </a>
                    </li>
                </ul>
                <ul class="nav">
                    <li>
                    <a href="#" class="dropdown">
                        <a href="#" class="dropdown-toggle" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fa fa-wrench"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right dropdown-primary" aria-labelledby="navbarDropdownMenuLink">
                            <a class="dropdown-item disconnected" onclick="javascript:enterPairingCode();">
                                <i class="fas fa-link"></i>&nbsp;<span class="i18n">Connect to terminal</span>
                            </a>
                            <a class="dropdown-item connected" onclick="javascript:unpair();">
                                <i class="fas fa-unlink"></i>&nbsp;<span class="i18n">Disconnect from terminal</span>
                            </a>
                            <div class="dropdown-divider"></div> 
                            <a class="dropdown-item" id="reboot" onclick="javascript:trm.deviceCommand({ DeviceCommandCode: trm.DeviceCommands.REBOOT });">
                                <i class="fas fa-power-off"></i>&nbsp;<span class="i18n">Reboot terminal</span>
                            </a>
                            <a class="dropdown-item" id="swUpdate" onclick="javascript:trm.deviceCommand({ DeviceCommandCode: trm.DeviceCommands.SW_UPDATE });">
                                <i class="fas fa-cloud-download-alt"></i>&nbsp;<span class="i18n">Update software</span>
                            </a>
                            <div class="dropdown-divider"></div> 
                            <a class="dropdown-item" id="reload" onclick="javascript:location.reload(true);">
                                <i class="fas fa-redo"></i>&nbsp;<span class="i18n">Reload page</span>
                            </a>
                        </div>
                    </a>
                    </li>
                </ul>
            </div>
            <div class="tab-content">
                <div id="paymentPane" class="tab-pane container show active section-spacer" role="tabpanel">
                    <div class="row">
                        <div class="col-12">
                            <form id="paymentForm" class="md-form needs-validation connected activated" action="javascript:transaction()" novalidate>
                                <div class="form-group">
                                    <label for="trxFunctionSelect" class="i18n">Function:</label>
                                    <select class="form-control" id="trxFunctionSelect"></select>
                                </div>
                                <div class="form-group amt-auth-needed">
                                    <label for="amtAuth" class="i18n">Amount:</label>
                                    <input type="text" inputmode="numeric" class="form-control" id="amtAuth" pattern="^\$?(([1-9](\d*|\d{0,2}(,\d{3})*))|0)(\.\d{1,2})?$" required></input>
                                    <div class="invalid-feedback">
                                        <div class="col-12 i18n">Invalid amount - valid values: 0.01 - 999999.99</div>
                                    </div>
                                </div>
                                <div class="form-group amt-other-needed">
                                    <label for="amtOther" class="i18n">Cashback:</label>
                                    <input type="text" inputmode="numeric" class="form-control" id="amtOther" pattern="^\$?(([1-9](\d*|\d{0,2}(,\d{3})*))|0)(\.\d{1,2})?$"></input>
                                    <div class="invalid-feedback">
                                        <div class="col-12 i18n">Invalid amount - valid values: 0.01 - 999999.99</div>
                                    </div>
                                </div>
                                <div class="form-group acq-id-needed">
                                    <label for="acqIDSelect" class="i18n">Acquirer:</label>
                                    <select class="form-control" id="acqIDSelect"></select>
                                </div>
                                <div class="form-group auth-c-needed">
                                    <label for="authC" class="i18n">Authorization code:</label>
                                    <input type="text" class="form-control" id="authC"></input>
                                </div>
                                <div class="form-group trx-ref-num-needed">
                                    <label for="trxRefNum" class="i18n">Reference number:</label>
                                    <input type="text" class="form-control" id="trxRefNum"></input>
                                </div>
                                <div class="form-group trx-seq-cnt-needed">
                                    <label for="trxSeqCnt" class="i18n">Sequence counter:</label>
                                    <input type="text" class="form-control" id="trxSeqCnt"></input>
                                </div>
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary btn-block btn-lg" id="pay">
                                        <i class="fas fa-check"></i>&nbsp;<span class="i18n">OK</span>
                                    </button>
                                    <button type="button" class="btn btn-outline-danger btn-lg initiallyHidden" id="abortTransactionButton" onclick="javascript:trm.abortTransaction();">
                                        <i class="fas fa-times"></i>&nbsp;<span class="i18n">Abort</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="disconnected text-center">
                        <button type="button" class="btn btn-primary btn-block btn-lg" onclick="javascript:enterPairingCode();">
                            <i class="fas fa-link"></i>&nbsp;<span class="i18n">Connect to terminal</span>
                        </button>
                    </div>
                    <div class="connected deactivated text-center">
                        <button type="button" class="btn btn-primary btn-block btn-lg i18n" id="activate" onclick="javascript:trm.activate()">Activate terminal</button>
                    </div>
                    <div class="section-spacer"></div>
                    <div class="connected activated text-center">
                        <button type="button" class="btn btn-primary btn-block i18n"
                            id="deactivate" onclick="javascript:trm.deactivate()">Deactivate terminal</button>
                    </div>
                    <div class="connected deactivated text-center button-spacer">
                        <button type="button" class="btn btn-primary btn-block i18n"
                            id="balance" onclick="javascript:trm.balance()">Final balance</button>
                    </div>
                    <div class="connected text-center button-spacer">
                        <button type="button" class="btn btn-primary btn-block i18n"
                            id="capture" onclick="javascript:trm.sendMessage({ BatchCaptureRequest: {}})">Submit transaction data</button>
                    </div>
                    <div class="connected text-center button-spacer">
                        <button type="button" class="btn btn-primary btn-block i18n"
                            id="config" onclick="javascript:trm.configure()">Configuration</button>
                    </div>
                    <div class="connected text-center button-spacer">
                        <div class="dropdown">
                            <button class="btn btn-primary btn-block dropdown-toggle i18n" type="button" data-toggle="dropdown">Initialisation<span class="caret"></span></button>
                            <ul class="dropdown-menu dropdown-primary" id="initAcquirerList"/>
                        </div>
                    </div>
                </div>
                <div id="receiptPane" class="tab-pane container" role="tabpanel">
                    <div class="text-right">
                        <button type="button" id="clearReceipts" class="btn btn-primary d-none" title="Clear" onclick="javascript:clearReceipts()">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div id="receipts">
                    </div>
                </div>
                <div id="infoPane" class="tab-pane container" role="tabpanel">
                    <div class="row info-title-1 i18n">Info:</div>
                    <div class="row info-title-2 i18n">Device model:</div>
                    <div class="row i18n" id="terminalModel">unknown</div>
                    <div class="row info-title-2 i18n">Trm-Id:</div>
                    <div class="row i18n" id="terminalID">unknown</div>
                    <div class="row info-title-2 i18n">Serial number:</div>
                    <div class="row i18n" id="serialNumber">unknown</div>
                    <div class="row info-title-2 i18n">Software version:</div>
                    <div class="row i18n" id="software">unknown</div>
                    <div class="row info-title-1 i18n">Processors</div>
                    <div class="i18n" id="acquirerInfo">[none]</div>
                    <div class="row info-title-1 i18n">Means of payment</div>
                    <div class="i18n" id="brandInfo">[none]</div>
                    <div class="row info-title-1 i18n">Transaction types</div>
                    <div class="i18n" id="trxFunctionInfo">[none]</div>
                </div>
                <div id="settingsPane" class="tab-pane container" role="tabpanel">
                    <div class="row form-group info-title-1 i18n">Sprache</div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="browserLanguageOnTrm" onclick="javascript:storeSettings();">
                        <label class="form-check-label i18n" for="browserLanguageOnTrm">Browser language on terminal</label>
                    </div>
                    <div class="row form-group info-title-1 printer-available i18n">Automatically print receipts on terminal</div>
                    <div class="form-check printer-available">
                        <input class="form-check-input" type="checkbox" value="" id="printMerchantReceipts" onclick="javascript:storeSettings();">
                        <label class="form-check-label i18n" for="printMerchantReceipts">Merchant receipts</label>
                    </div>
                    <div class="form-check printer-available">
                        <input class="form-check-input" type="checkbox" value="" id="printCardholderReceipts" onclick="javascript:storeSettings();">
                        <label class="form-check-label i18n" for="printCardholderReceipts">Cardholder receipts</label>
                    </div>
                    <div class="form-check printer-available">
                        <input class="form-check-input" type="checkbox" value="" id="printInfoReceipts" onclick="javascript:storeSettings();">
                        <label class="form-check-label i18n" for="printInfoReceipts">Information receipts</label>
                    </div>
                </div>
            </div>
            <div id="dialog" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 id="dialogTitle" class="modal-title"></h4>
                            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>
                        </div>
                        <div class="modal-body">
                            <p id="dialogText"></p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-dismiss="modal"><span class="i18n">OK</span></button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="pairingDialog" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <form class="form-horizontal" role="form" method="post" action="">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 id="pairingDialogTitle" class="modal-title i18n">Pairing with Terminal</h4>
                                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>
                            </div>
                            <div class="modal-body">
                                <p class="i18n" id="pairingDialogText">Please enter the pairing code:</p>
                                <input type="number" id="pairingCode"></input>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary" data-dismiss="modal" onclick="javascript:doPairing($('#pairingCode')[0].value);">
                                    <i class="fas fa-check"></i>&nbsp;<span class="i18n">OK</span>
                                </button>
                                <button type="button" class="btn btn-outline-danger" data-dismiss="modal">
                                    <i class="fas fa-times"></i>&nbsp;<span class="i18n">Abort</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script src="//code.jquery.com/jquery-3.3.1.slim.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
        <script src="//stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
        <script src="//ecritf.paytec.ch/api/v1.0/ecritf.js"></script>

        <script language = "javascript" type = "text/javascript">
            var language = navigator.language.split("-")[0];
            var trm;
            var dialogTimer = undefined;
            var trmStatus = 0;
            var pairingInfo;
            var ONLINE_ADVICE = 0x11111111; // private function to confirm AUTHORIZATION_PURCHASE transactions (petrol use case)
            var lastTrxSeqCnt = -1;

            // IE compatibility
            Math.trunc = Math.trunc || function(x) {
              if (isNaN(x)) {
                return NaN;
              }
              if (x > 0) {
                return Math.floor(x);
              }
              return Math.ceil(x);
            };

            $(".connected").hide();
            $(".activated").hide();

            if (typeof(Storage) !== "undefined") {
                let info = localStorage.getItem("pairingInfo");

                if (info !== undefined) {
                    try {
                        pairingInfo = JSON.parse(info);
                    }
                    catch (err) {
                        console.log("Cannot parse pairing info");
                        pairingInfo = undefined;
                    }
                }

                $("#browserLanguageOnTrm").prop('checked', localStorage.getItem("browserLanguageOnTrm") == "true");
                $("#printMerchantReceipts").prop('checked', localStorage.getItem("printMerchantReceipts") == "true");
                $("#printCardholderReceipts").prop('checked', localStorage.getItem("printCardholderReceipts") == "true");
                $("#printInfoReceipts").prop('checked', localStorage.getItem("printInfoReceipts") == "true");
            }

            trm = new PayTec.POSTerminal(pairingInfo, {
                    OnPairingFailed: onPairingFailed,
                    OnConnected: onConnected,
                    OnDisconnected: onDisconnected,
                    OnStatusChanged: onStatusChanged,
                    OnTransactionApproved: onTransactionApproved,
                    OnTransactionDeclined: onTransactionFailed,
                    OnTransactionAborted: onTransactionFailed,
                    OnTransactionTimedOut: onTransactionTimedOut,
                    OnActivationSucceeded: resetTransactionUI,
                    OnInitializationSucceeded: resetTransactionUI,
                    OnConfigurationSucceeded: resetTransactionUI,
                    OnTransactionConfirmationSucceeded: resetTransactionUI,
                    OnTransactionConfirmationFailed: resetTransactionUI,
                    OnTransactionConfirmationTimedOut: resetTransactionUI,
                    OnReceipt: onReceipt,
                    OnError: onError
                });

            if ($("#browserLanguageOnTrm").is(":checked")) {
                trm.setTrmLng(language);
            }

            function onConnected() {
                if (dialogTimer == undefined) {
                    setDialogTimer(500);
                }

                $("#terminalModel").html(trm.getDeviceModelName());
                $("#serialNumber").html(trm.getSerialNumber());
                $("#terminalID").html(trm.getTerminalID());

                v = trm.getSoftwareVersion();

                $("#software").html(pad(Math.trunc(v / 10000), 2, '0')
                    + "." + pad(Math.trunc((v % 10000) / 100), 2, '0')
                    + "." + pad(Math.trunc(v % 100), 2, '0'));

                $(".connected").show();
                $(".disconnected").hide();
                $(".activated").hide();
                $(".deactivated").hide();
            }

            function onPairingFailed() {
                showDialog(i18n("Error"), i18n("Failed to connect to terminal"), 10000);
            }

            function onStatusChanged() {
                var newStatus = trm.getStatus();
                var oldStatus = trmStatus;

                if ((trm.StatusFlags.OUT_OF_PAPER & newStatus) != (trm.StatusFlags.OUT_OF_PAPER & trmStatus)) {
                    if (trm.StatusFlags.OUT_OF_PAPER & newStatus) {
                        showDialog(i18n("Printer problem"), i18n("Please exchange paper roll"), Infinity);
                    }
                    else {
                        if (dialogTimer == undefined) {
                            setDialogTimer(500);
                        }
                    }
                }
                else if ((trm.StatusFlags.WAITING_FOR_TRANSACTION_REQUEST & newStatus) && !(trm.StatusFlags.WAITING_FOR_TRANSACTION_REQUEST & trmStatus)) {
                    $("#amtAuth").focus();
                    hideDialog();
                }
                else if (((trm.StatusFlags.BUSY & newStatus) != (trm.StatusFlags.BUSY & trmStatus)) && $("#abortTransactionButton").is(":hidden")) {
                    if (trm.StatusFlags.BUSY & newStatus) {
                        showDialog(i18n("Please wait"), i18n("Please wait"), Infinity);
                    }
                    else {
                        if (dialogTimer == undefined) {
                            setDialogTimer(500);
                        }
                    }
                }

                trmStatus = newStatus;
                applyPrinterStatus();

                if (trm.StatusFlags.SHIFT_OPEN & trmStatus) {
                    $(".deactivated").hide();
                    $(".activated").show();
                }
                else {
                    $(".deactivated").show();
                    $(".activated").hide();
                }

                $("#busy").toggle((trm.StatusFlags.BUSY & trmStatus) != 0);
                $("#onlineProcessing").toggle((trm.StatusFlags.ONLINE_PROCESSING & trmStatus) != 0);
                $("#cardDataAvailable").toggle(((trm.StatusFlags.CARD_DATA_AVAILABLE | trm.StatusFlags.APPLICATION_SELECTED) & trmStatus) != 0);

                if (!(trm.StatusFlags.BUSY & trmStatus)) {
                    // update acquirers
                    var acquirerInfoHTML = "";
                    var acqIDSelectHTML = "";
                    var initAcquirerListHTML = "<li><a class='dropdown-item' onclick='javascript:trm.initialize(-1);'>" + i18n("all") + "</a></li>";
                    var acquirers = trm.getAcquirers();

                    for (var i in acquirers) {
                        var acqInfo = trm.getAcquirerInfo(acquirers[i]);
                        var lastInitDate = acqInfo.LastAcqInitDate === undefined ? i18n("never") : acqInfo.LastAcqInitDate;

                        acquirerInfoHTML +=
                            "<div class='row'>"
                                + "<div class='col text-left'>Acquirer ID: " + acqInfo.AcqID
                                + "</div>"
                                + "<div class='col text-left'>" + i18n("successfully initialised: ") + lastInitDate
                                + "</div>"
                                + "<div class='col text-right'>"
                                    + "<button type='button' class='btn btn-primary connected' onclick='javascript:trm.initialize(" + acqInfo.AcqID + ");'>"
                                        + "<i class=\"fas fa-redo\"></i>"
                                    + "</button>"
                                + "</div>"
                            + "</div>";

                        acqIDSelectHTML += "<option value='" + acqInfo.AcqID + "'>" + acqInfo.AcqID + "</option>";
                        initAcquirerListHTML += "<li><a class='dropdown-item' onclick='javascript:trm.initialize(" + acqInfo.AcqID + ");'>Acq&nbsp;" + acqInfo.AcqID + "</a></li>";
                    }

                    $("#acquirerInfo").html(acquirerInfoHTML);
                    $("#acqIDSelect").html(acqIDSelectHTML);
                    $("#initAcquirerList").html(initAcquirerListHTML);

                    // update supported brands & transaction functions
                    var brandInfoHTML = "";
                    var brands = trm.getBrands();

                    for (var i in brands) {
                        var brand = brands[i];

                        brandInfoHTML +=
                            "<div class='row'>"
                                + "<div class='col-3'>" + brand + "</div>"
                            + "</div>";
                    }

                    $("#brandInfo").html(brandInfoHTML);

                    var trxFunctionInfoHTML = "";
                    var trxFunctionSelectHTML = "";
                    var trxFunctions = trm.getTransactionFunctions();

                    for (var i in trxFunctions) {
                        var name = trm.getTransactionFunctionName(trxFunctions[i], language);
                        trxFunctionInfoHTML += "<div class='row'><div class='col'>" + name + "</div></div>";
                        trxFunctionSelectHTML += "<option value='" + trxFunctions[i] + "'>" + name + "</option>";

                        if (trm.TransactionFunctions.AUTHORIZATION_PURCHASE == trxFunctions[i]) {
                            trxFunctionSelectHTML += "<option value='" + ONLINE_ADVICE + "'>" + "Online Advice" + "</option>";
                        }
                    }

                    $("#trxFunctionInfo").html(trxFunctionInfoHTML);
                    $("#trxFunctionSelect").html(trxFunctionSelectHTML);
                }
            }

            function resetTransactionUI() {
                $("#abortTransactionButton").hide();
                $("#pay").show();
                $("#acqIDSelect").val($("#acqIDSelect option:first").val());
                $("#amtAuth")[0].value = "";
                $("#amtOther")[0].value = "";
                $("#authC")[0].value = "";
                $("#trxRefNum")[0].value = "";
                $("#trxSeqCnt")[0].value = lastTrxSeqCnt;
                $("#trxFunctionSelect").val($("#trxFunctionSelect option:first").val());
                $("#trxFunctionSelect").trigger("change");
            }

            function onTransactionApproved(rsp) {
                lastTrxSeqCnt = rsp.TrxSeqCnt;
                resetTransactionUI();
                showDialog(i18n("Processing OK"), rsp.AttendantText, 5000);
            }

            function onTransactionFailed(rsp) {
                resetTransactionUI();
                showDialog(i18n("Processing failed"), rsp.AttendantText, 30000);
            }

            function onTransactionTimedOut() {
                resetTransactionUI();
                showDialog(i18n("Processing failed"), "Timeout", 30000);
            }

            function onReceipt(receiptType, receiptText) {
                $("#receipts").html("<div>"
                            + "<span class='print-tooltip' data-toggle='tooltip' title=''>"
                                + "<button type='button' class='print-button btn btn-primary connected' onclick='javascript:print(\"" + receiptText.replace(/\n/g, "\\n") + "\");'><i class=\"fas fa-print\"></i>"
                                + "</button>"
                            + "</span>"
                            + "<pre>"
                                + receiptText.replace("\\n", "\n") + "  ----------------------------  \n\n"
                            + "</pre>"
                        + "</div>"
                    + $("#receipts").html());

                applyPrinterStatus();
                $("#clearReceipts").removeClass("d-none");

                while ($("#receipts").children().length > 20) {
                    $("#receipts > div:last-child").remove();
                }

                if (0 == ((trm.StatusFlags.PRINTER_UNAVAILABLE | trm.StatusFlags.OUT_OF_PAPER) & trmStatus)) {
                    var doPrint = false;

                    switch (receiptType) {
                        case trm.ReceiptTypes.TRX:
                        case trm.ReceiptTypes.FINAL_BALANCE:
                        case trm.ReceiptTypes.FINAL_BALANCE_FAILED:
                            if ($("#printMerchantReceipts").is(":checked"))
                                doPrint = true;

                            break;
                        case trm.ReceiptTypes.TRX_COPY:
                            if ($("#printCardholderReceipts").is(":checked"))
                                doPrint = true;

                            break;
                        default:
                            if ($("#printInfoReceipts").is(":checked"))
                                doPrint = true;

                            break;
                    }

                    if (doPrint) {
                        print(receiptText);
                    }
                }
            }

            function onDisconnected() {
                $(".connected").hide();
                $(".status").hide();
                $(".disconnected").show();
            }

            function onError(message) {
                showDialog("Fehler", message, 60000);
            }

            function enterPairingCode() {
                $("#pairingCode")[0].value = "";
                $("#pairingDialog").modal("show");
            }

            function doPairing(code) {
                showDialog(i18n("Please wait"), i18n("Connection is being established"), Infinity);
                trm.pair(code, document.title);

                if (typeof(Storage) !== "undefined") {
                    localStorage.setItem("pairingInfo", JSON.stringify(trm.getPairingInfo()));
                }
            }

            function unpair() {
                trm.unpair();

                if (typeof(Storage) !== "undefined") {
                    localStorage.setItem("pairingInfo", undefined);
                }
            }

            function transaction() {
                var trxFunction = Number($("#trxFunctionSelect").find(":selected")[0].value);

                if (ONLINE_ADVICE == trxFunction) {
                    trm.confirmTransaction({
                            Confirm: 1,
                            TrxAmt: Math.round(Number($("#amtAuth")[0].value) * 100),
                            TrxSeqCnt: Number($("#trxSeqCnt")[0].value)
                        });
                }
                else {
                    var req = {
                        TrxFunction: trxFunction
                    };
                    
                    if (trm.needsAmtAuth(trxFunction) || trm.needsAmtOther(trxFunction)) {
                        req.TrxCurrC = trm.getCurrencies()[0];
                    }

                    if (trm.needsAmtAuth(trxFunction)) {
                        req.AmtAuth = Math.round(Number($("#amtAuth")[0].value) * 100);
                    }

                    if (trm.needsAmtOther(trxFunction)) {
                        req.AmtOther = Math.round(Number($("#amtOther")[0].value) * 100);
                    }

                    if (trm.needsAcqID(trxFunction)) {
                        req.AcqID = Number($("#acqIDSelect").find(":selected")[0].value);
                    }

                    if (trm.needsAuthC(trxFunction)) {
                        req.AuthC = String($("#authC")[0].value);
                    }

                    if (trm.needsTrxRefNum(trxFunction)) {
                        req.TrxRefNum = String($("#trxRefNum")[0].value);
                    }

                    trm.startTransaction(req);
                    $("#abortTransactionButton").show();
                }

                $("#paymentForm").removeClass("was-validated");
                $("#pay").hide();
            }

            function print(text) {
                var lines = text.replace(/\\n/g, "\n").split('\n');

                if (trm.StatusFlags.OUT_OF_PAPER & trmStatus) {
                    showDialog(i18n("Out of paper"), i18("Please exchange paper roll on terminal printer"), 10000);
                }
                else if (trm.StatusFlags.PRINTER_UNAVAILABLE & trmStatus) {
                    var printerWindow = window.open('', '', 'left=0,top=0,width=800,height=900,toolbar=0,scrollbars=0,status=0');
                    printerWindow.document.write("<pre>" + lines.join('\n') + "</pre>");
                    printerWindow.document.close();
                    printerWindow.focus();
                    printerWindow.print();
                    printerWindow.close();
                }
                else {
                    trm.print({ ReceiptText: lines.slice(0, 1).join('\n'), ReceiptFlags: trm.ReceiptFlags.DOUBLE_HEIGHT | trm.ReceiptFlags.MORE_DATA_AVAILABLE });
                    trm.print({ ReceiptText: lines.slice(1).join('\n') });
                }
            }

            function applyPrinterStatus() {
                if (trm.StatusFlags.PRINTER_UNAVAILABLE & trmStatus) {
                    $(".print-tooltip").attr('data-original-title', i18n("Printing via browser")).tooltip("enable");
                }
                else if (trm.StatusFlags.OUT_OF_PAPER & trmStatus) {
                    $(".print-tooltip").attr('data-original-title', i18n("Printing via terminal - please exchange paper roll")).tooltip("enable");
                }
                else {
                    $(".print-tooltip").attr('data-original-title', i18n("Printing via terminal")).tooltip("enable");
                }

                if (trm.StatusFlags.PRINTER_UNAVAILABLE & trmStatus) {
                    $(".printer-available").hide();
                }
                else {
                    $(".printer-available").show();
                }
            }

            function storeSettings() {
                if (typeof(Storage) !== "undefined") {
                    localStorage.setItem("browserLanguageOnTrm", $("#browserLanguageOnTrm").is(":checked") ? "true" : "false");
                    localStorage.setItem("printMerchantReceipts", $("#printMerchantReceipts").is(":checked") ? "true" : "false");
                    localStorage.setItem("printCardholderReceipts", $("#printCardholderReceipts").is(":checked") ? "true" : "false");
                    localStorage.setItem("printInfoReceipts", $("#printInfoReceipts").is(":checked") ? "true" : "false");
                }
            }

            function clearDialogTimer() {
                if (undefined !== dialogTimer) {
                    clearTimeout(dialogTimer);
                    dialogTimer = undefined;
                }
            }

            function setDialogTimer(timeout) {
                clearDialogTimer();

                if (Infinity != timeout) {
                    dialogTimer = setTimeout(function () {
                            hideDialog();
                        }, timeout);
                }
            }

            function showDialog(title, text, timeout) {
                $("#dialogTitle")[0].innerText = title;
                $("#dialogText")[0].innerText = text;

                $("#dialog").modal("show");
                setDialogTimer(timeout);
            }
            
            function hideDialog() {
                clearDialogTimer();
                $("#dialog").modal("hide");
            }

            function clearReceipts() {
                $("#receipts").html("");
                $("#clearReceipts").addClass("d-none");
            }

            function pad(num, padlen, padchar) {
                var pad_char = typeof padchar !== 'undefined' ? padchar : '0';
                var padArray = new Array(1 + padlen).join(pad_char);
                return (padArray + num).slice(-padArray.length);
            }

            window.addEventListener('load', function() {
                $("#pairingDialog").on('shown.bs.modal', function(){
                    $(this).find('#pairingCode').focus();
                });

                $('#trxFunctionSelect').change(function() {
                    var selectedFunction = $("#trxFunctionSelect").val();

                    if (ONLINE_ADVICE == selectedFunction) {
                        $(".trx-seq-cnt-needed").show();
                        $(".amt-auth-needed").show();
                        $(".acq-id-needed").hide();
                        $(".amt-other-needed").hide();
                        $(".auth-c-needed").hide();
                        $(".trx-ref-num-needed").hide();
                    }
                    else {
                        if (trm.needsAcqID(selectedFunction)) {
                            $(".acq-id-needed").show();
                        }
                        else {
                            $(".acq-id-needed").hide();
                        }

                        if (trm.needsAmtAuth(selectedFunction)) {
                            $(".amt-auth-needed").show();
                        }
                        else {
                            $(".amt-auth-needed").hide();
                        }

                        if (trm.needsAmtOther(selectedFunction)) {
                            $(".amt-other-needed").show();
                        }
                        else {
                            $(".amt-other-needed").hide();
                        }

                        if (trm.needsAuthC(selectedFunction)) {
                            $(".auth-c-needed").show();
                        }
                        else {
                            $(".auth-c-needed").hide();
                        }

                        if (trm.needsTrxRefNum(selectedFunction)) {
                            $(".trx-ref-num-needed").show();
                        }
                        else {
                            $(".trx-ref-num-needed").hide();
                        }

                        $(".trx-seq-cnt-needed").hide();
                    }

                    $("#paymentForm").removeClass("was-validated");
                });

                var forms = document.getElementsByClassName('needs-validation');

                var validation = Array.prototype.filter.call(forms, function(form) {
                    form.addEventListener('submit', function(event) {
                        if (trm.needsAmtAuth($("#trxFunctionSelect").val())) {
                            if (form.checkValidity() === false) {
                                event.preventDefault();
                                event.stopPropagation();
                            }
                            form.classList.add('was-validated');
                        }
                    }, false);
                });

                $(".i18n").each(function () {
                    $(this).text(i18n(this.innerText));
                    if (this.hasAttribute("title")) {
                        this.setAttribute("title", i18n(this.getAttribute("title")));
                    }
                });
            }, false);

            function i18n(text) {
                let result = text;
                let dictEntry = translations[text];

                if (dictEntry !== undefined) {
                    let translation = dictEntry[language];

                    if (translation !== undefined) {
                        result = translation;
                    }                    
                }

                return result;
            }

            var translations = {
                "all": {
                    "de": "alle",
                    "fr": "tous",
                    "it": "tutti"
                },
                "Browser language on terminal": {
                    "de": "Browser-Sprache auf Terminal",
                    "fr": "Langue du navigateur sur le terminal",
                    "it": "Lingua del browser sul terminale"
                },
                "Terminal is online": {
                    "de": "Terminal ist online",
                    "fr": "Terminal online",
                    "it": "Terminale online"
                },
                "Card has been read": {
                    "de": "Karte wurde gelesen",
                    "fr": "La carte a été lue",
                    "it": "La carta è stata letta"
                },
                "Terminal is busy": {
                    "de": "Terminal ist beschäftigt",
                    "fr": "Le terminal est occupé",
                    "it": "Il terminale è occupato"
                },
                "Shift is open": {
                    "de": "Schicht geöffnet",
                    "fr": "Terminal activé",
                    "it": "Terminale attivo"
                },
                "Shift is closed": {
                    "de": "Schicht geschlossen",
                    "fr": "Terminal pas activé",
                    "it": "Terminale non attivo"
                },
                "Connected to terminal": {
                    "de": "Verbunden mit Terminal",
                    "fr": "Connecté au terminal",
                    "it": "Collegato al terminale"
                },
                "No terminal connected": {
                    "de": "Kein Terminal angeschlossen",
                    "fr": "Aucun terminal connecté",
                    "it": "Nessun terminale collegato"
                },
                "Connect to terminal": {
                    "de": "Mit Terminal verbinden",
                    "fr": "Connecter au terminal",
                    "it": "Collegare al terminale"
                },
                "Disconnect from terminal": {
                    "de": "Verbindung aufheben",
                    "fr": "Déconnecter du terminal",
                    "it": "Scollegamento dal terminale"
                },
                "Reboot terminal": {
                    "de": "Terminal neu starten",
                    "fr": "Redémarrer le terminal",
                    "it": "Riavviare il terminale"
                },
                "Update software": {
                    "de": "SW Update",
                    "fr": "Téléchargement",
                    "it": "Caricare SW"
                },
                "Reload page": {
                    "de": "Seite neu laden",
                    "fr": "Recharger la page",
                    "it": "Ricarica la pagina"
                },
                "Function:": {
                    "de": "Funktion:",
                    "fr": "Fonction:",
                    "it": "Funzione:"
                },
                "Amount:": {
                    "de": "Betrag:",
                    "fr": "Montant:",
                    "it": "Importo:"
                },
                "Invalid amount - valid values: 0.01 - 999999.99": {
                    "de": "Ungültiger Betrag - gültige Werte: 0.01 - 999999.99",
                    "fr": "Montant non valable - valeurs valables : 0,01 - 99999999,99",
                    "it": "Importo non valido - valori validi: 0,01 - 99999999.99."
                },
                "Abort": {
                    "de": "Abbruch",
                    "fr": "Interruption",
                    "it": "Interruzione"
                },
                "Activate terminal": {
                    "de": "Terminal aktivieren",
                    "fr": "Activer le terminal",
                    "it": "Attiva terminale"
                },
                "Deactivate terminal": {
                    "de": "Terminal deaktivieren",
                    "fr": "Désactiver terminal",
                    "it": "Disattiva terminale"
                },
                "Final balance": {
                    "de": "Tagesabschluss",
                    "fr": "Clôture journalière",
                    "it": "Chiusura giornaliera"
                },
                "Configuration": {
                    "de": "Konfiguration",
                    "fr": "Configuration",
                    "it": "Configurazione"
                },
                "Initialisation": {
                    "de": "Initialisierung",
                    "fr": "Initialisation",
                    "it": "Inizializzazione"
                },
                "Device model:": {
                    "de": "Gerätemodell:",
                    "fr": "Modèle d'appareil:",
                    "it": "Modello di dispositivo:"
                },
                "never": {
                    "de": "nie",
                    "fr": "jamais",
                    "it": "mai"
                },
                "unknown": {
                    "de": "unbekannt",
                    "fr": "inconnu",
                    "it": "sconosciuto"
                },
                "Trm-Id:": {
                    "de": "Trm-Id:",
                    "fr": "Trm-Id:",
                    "it": "Trm-Id:"
                },
                "Serial number:": {
                    "de": "Seriennummer:",
                    "fr": "Numéro de série:",
                    "it": "Numero di serie:"
                },
                "Software version:": {
                    "de": "Softwareversion:",
                    "fr": "Version du logiciel:",
                    "it": "Versione software:"
                },
                "Submit transaction data": {
                    "de": "Transaktionsdaten einliefern",
                    "fr": "Soumettre des données de transaction",
                    "it": "Inviare i dati delle transazioni"
                },
                "Processors": {
                    "de": "Verarbeiter",
                    "fr": "Transformateurs",
                    "it": "Processori"
                },
                "[none]": {
                    "de": "[keine]",
                    "fr": "[aucun]",
                    "it": "[nessun]"
                },
                "Means of payment": {
                    "de": "Zahlungsmittel",
                    "fr": "Moyens de paiement",
                    "it": "Mezzi di pagamento"
                },
                "Transaction types": {
                    "de": "Transaktionstypen",
                    "fr": "Types de transaction",
                    "it": "Tipi di transazione"
                },
                "Pairing with Terminal": {
                    "de": "Pairing mit Terminal",
                    "fr": "Appairage du terminal",
                    "it": "Accoppiare il terminale"
                },
                "Please enter the pairing code:": {
                    "de": "Bitte Pairing Code eingeben:",
                    "fr": "Veuillez entrer le code d'appariement:",
                    "it": "Inserire il codice di accoppiamento:"
                },
                "Error": {
                    "de": "Fehler",
                    "fr": "Erreur",
                    "it": "Errore"
                },
                "Failed to connect to terminal": {
                    "de": "Es konnte keine Verbindung zum Terminal hergestellt werden",
                    "fr": "Aucune connexion n'a pu être établie avec le terminal",
                    "it": "Non è stato possibile stabilire un collegamento con il terminale"
                },
                "Printer problem": {
                    "de": "Druckerproblem",
                    "fr": "Problème d'imprimante",
                    "it": "Problema stampante"
                },
                "Please exchange paper roll": {
                    "de": "Bitte Papierrolle wechseln",
                    "fr": "Remplacer le rouleau de papier",
                    "it": "Sostituire il rotolo di carta"
                },
                "successfully initialised: ": {
                    "de": "erfolgreich initialisiert: ",
                    "fr": "initialisé avec succès: ",
                    "it": "inizializzato con successo: "
                },
                "Processing OK": {
                    "de": "Verarbeitung OK",
                    "fr": "Traitement OK",
                    "it": "Elaborazione OK"
                },
                "Processing failed": {
                    "de": "Verarbeitung fehlgeschlagen",
                    "fr": "Erreur de traitement",
                    "it": "Errore di elaborazione"
                },
                "Connection is being established": {
                    "de": "Verbindung wird hergestellt",
                    "fr": "La connexion est en cours d'établissement",
                    "it": "La connessione è in corso di realizzazione"
                },
                "Out of paper": {
                    "de": "Kein Papier",
                    "fr": "Manque de papier",
                    "it": "Carta stampante esaurita"
                },
                "Please exchange paper roll on terminal printer": {
                    "de": "Bitte Papier am Terminaldrucker wechseln",
                    "fr": "Remplacer le rouleau de papier sur l'imprimante du terminal",
                    "it": "Sostituire il rotolo di carta stampante del terminale"
                },
                "Printing via browser": {
                    "de": "Druck via Browser",
                    "fr": "Impression par navigateur",
                    "it": "Stampa su Browser"
                },
                "Printing via terminal - please exchange paper roll": {
                    "de": "Druck via Terminal - bitte Papier wechseln",
                    "fr": "Impression par terminal - échangez le rouleau de papier s.v.p.",
                    "it": "Stampa su terminale - si prega di sostituire il rotolo di carta"
                },
                "Printing via terminal": {
                    "de": "Druck via Terminal",
                    "fr": "Impression par terminal",
                    "it": "Stampa su terminale"
                },
                "Please wait": {
                    "de": "Bitte warten",
                    "fr": "Un instant s.v.p.",
                    "it": "Attendere prego"
                },
                "Merchant receipts": {
                    "de": "Händlerbelege",
                    "fr": "Reçus du marchand",
                    "it": "Ricevute mercante"
                },
                "Cardholder receipts": {
                    "de": "Kundenbelege",
                    "fr": "Reçus du client",
                    "it": "Ricevute cliente"
                },
                "Information receipts": {
                    "de": "Infobelege",
                    "fr": "Reçus d'information",
                    "it": "Ricevute di informazione"
                },
                "Automatically print receipts on terminal": {
                    "de": "Belege automatisch auf Terminal drucken",
                    "fr": "Impression automatique des reçus sur le terminal",
                    "it": "Stampa automaticamente le ricevute sul terminale"
                },
                "Authorization code:": {
                    "de": "Autorisierungsscode:",
                    "fr": "Code autorisation:",
                    "it": "Codice Autorizzazione:"
                },
                "Sequence counter:": {
                    "de": "Sequenznummer:",
                    "fr": "Compteur de séquences:",
                    "it": "Contatore di sequenza:"
                },
                "Reference number:": {
                    "de": "Referenznummer:",
                    "fr": "Numéro de référence:",
                    "it": "Numero di riferimento:"
                },
            };
        </script>
    </body>
</html>